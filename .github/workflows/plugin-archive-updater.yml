name: Plugin Zip and Create PR

on:
  push:
    paths:
      - 'config/var/www/wordpress/plugins/simple-site-exporter-enginescript/simple-site-exporter.php'
    branches:
      - master # Or your main branch name

jobs:
  zip_and_pr:
    runs-on: ubuntu-latest
    # Define permissions needed by the job
    permissions:
      contents: write      # To push the new branch and commit the zip file
      pull-requests: write # To create the pull request
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Plugin Version
        id: version
        run: |
          # Extract version from the PHP file header
          plugin_file="config/var/www/wordpress/plugins/simple-site-exporter-enginescript/simple-site-exporter.php"
          version_line=$(grep -i '^Version:' "$plugin_file")
          plugin_version=$(echo "$version_line" | sed -n 's/Version:[[:space:]]*\([0-9.]*\).*/\1/p')
          echo "version=${plugin_version}" >> $GITHUB_OUTPUT
          echo "Detected version: $plugin_version"

      - name: Create Zip Archive
        run: |
          plugin_source_dir="config/var/www/wordpress/plugins/simple-site-exporter-enginescript"
          plugin_name="simple-site-exporter-enginescript"
          zip_filename="${plugin_name}.zip"
          # Parent directory where the plugin source lives and where the zip will be created
          parent_dir="config/var/www/wordpress/plugins"
          # Full path to the zip file relative to repo root (for echo message)
          target_path_from_root="${parent_dir}/${zip_filename}"

          echo "Navigating to parent directory: ${parent_dir}"
          cd "${parent_dir}" || { echo "Error: Failed to change directory to ${parent_dir}"; exit 1; }

          echo "Creating zip file '${zip_filename}' from source directory '${plugin_name}/'"
          # Create the zip file in the current directory (parent_dir)
          # Source directory (${plugin_name}/) is relative to current dir (parent_dir)
          zip -r "${zip_filename}" "${plugin_name}/" -x "${plugin_name}/.*" -x "${plugin_name}/__MACOSX"

          # Echo the path relative to the repository root
          echo "Created/Updated zip file at: ${target_path_from_root}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Or a PAT if needed for cross-repo workflows
          commit-message: "Update simple-site-exporter-enginescript.zip to v${{ steps.version.outputs.version }}"
          committer: GitHub <noreply@github.com> # Optional: Customize committer
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com> # Optional: Customize author
          signoff: false # Optional: Add a Signed-off-by trailer
          branch: "update-simple-site-exporter-zip-${{ steps.version.outputs.version }}" # Create a unique branch
          delete-branch: true # Optional: Delete branch after PR is merged/closed
          title: "Update simple-site-exporter-enginescript.zip to v${{ steps.version.outputs.version }}"
          body: |
            Automated update of `simple-site-exporter-enginescript.zip` following changes to the source PHP file.

            Plugin Version: ${{ steps.version.outputs.version }}
          labels: |
            automated-pr
            plugin-update
          assignees: ${{ github.actor }} # Optional: Assign the user who pushed
          reviewers: # Optional: Add reviewers
          draft: false # Optional: Create a draft PR