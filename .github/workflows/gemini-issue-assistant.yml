name: Gemini Issue Assistant

on:
  issues:
    types: [opened]

jobs:
  analyze-issue:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install Google AI SDK and Create Analysis Script
        run: |
          echo "ğŸ”§ Installing Google AI SDK..."
          npm install @google/generative-ai
          
          echo "ğŸ“¦ Creating Gemini analysis script..."
          cat > gemini-analyze.js << 'SCRIPT_EOF'
          const { GoogleGenerativeAI } = require('@google/generative-ai');
          const fs = require('fs');
          
          async function analyzeIssue() {
            try {
              const apiKey = process.env.GEMINI_API_KEY;
              if (!apiKey) {
                throw new Error('GEMINI_API_KEY environment variable not found');
              }
              
              console.log('ğŸ”‘ API key configured, length:', apiKey.length);
              console.log('ğŸ¤– Initializing Gemini AI...');
              
              const genAI = new GoogleGenerativeAI(apiKey);
              
              // Try different model names prioritizing quality first, then fallback on rate limits
              // Order: 2.5 models (highest quality) -> 2.0 models (higher RPM) -> legacy
              const modelNames = [
                "gemini-2.5-pro",             // 5 RPM, 250K TPM - Highest quality
                "gemini-2.5-flash",           // 10 RPM, 250K TPM - Best 2.5 balance
                "gemini-2.5-flash-preview",   // 10 RPM, 250K TPM - Latest 2.5 features
                "gemini-2.5-flash-lite",      // 15 RPM, 250K TPM - Faster 2.5
                "gemini-2.5-flash-lite-preview", // 15 RPM, 250K TPM - Latest 2.5 lite
                "gemini-2.0-flash",           // 15 RPM, 1M TPM - Good 2.0 balance
                "gemini-2.0-flash-lite",      // 30 RPM, 1M TPM - Highest RPM fallback
                "gemini-1.5-flash",           // 15 RPM, 250K TPM - DEPRECATED fallback
                "gemini-pro"                  // Legacy final fallback
              ];
              
              let model = null;
              let modelUsed = null;
              
              for (const modelName of modelNames) {
                try {
                  console.log('ğŸ”§ Trying model:', modelName);
                  model = genAI.getGenerativeModel({ model: modelName });
                  
                  // Test the model with a small request to check availability/rate limits
                  console.log('ğŸ§ª Testing model availability...');
                  await model.generateContent("test");
                  
                  modelUsed = modelName;
                  console.log('âœ… Successfully initialized and tested model:', modelName);
                  break;
                } catch (modelError) {
                  console.log('âŒ Model', modelName, 'failed:', modelError.message);
                  
                  // Check for rate limit errors specifically
                  if (modelError.message && (
                    modelError.message.includes('rate limit') || 
                    modelError.message.includes('quota') ||
                    modelError.message.includes('429') ||
                    modelError.status === 429
                  )) {
                    console.log('âš ï¸ Rate limit detected, trying next model with higher RPM...');
                  } else if (modelError.message && modelError.message.includes('404')) {
                    console.log('âš ï¸ Model not found, trying next available model...');
                  }
                  continue;
                }
              }
              
              if (!model) {
                throw new Error('No supported Gemini model could be initialized');
              }
              
              const prompt = fs.readFileSync('analysis_prompt.txt', 'utf8');
              console.log('ğŸ“ Prompt loaded, size:', prompt.length, 'characters');
              
              console.log('ğŸš€ Generating analysis with model:', modelUsed);
              const result = await model.generateContent(prompt);
              const response = await result.response;
              const text = response.text();
              
              fs.writeFileSync('gemini_response.txt', text);
              console.log('âœ… Analysis completed successfully');
              console.log('ğŸ“„ Result size:', text.length, 'characters');
              
            } catch (error) {
              console.error('âŒ Gemini analysis failed:', error.message);
              console.error('ğŸ” Full error details:', error);
              
              const fallbackContent = [
                '## ğŸ¤– AI Analysis Status',
                '',
                'The automated AI analysis encountered an issue: ' + error.message,
                '',
                'This may be due to:',
                '- API key configuration issues',
                '- Network connectivity problems',
                '- Gemini API rate limits or service issues',
                '- Invalid prompt format or size',
                '',
                '### Manual Review Recommended',
                'Please review this issue manually and check the repository for related code.',
                ''
              ].join('\n');
              
              fs.writeFileSync('gemini_response.txt', fallbackContent);
              process.exit(1);
            }
          }
          
          analyzeIssue().catch(error => {
            console.error('Fatal error:', error);
            process.exit(1);
          });
          SCRIPT_EOF
          
          echo "âœ… Analysis script created successfully"

      - name: Determine analysis type
        id: analysis-type
        env:
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
        run: |
          echo "type=issue-analysis" >> $GITHUB_OUTPUT
          echo "Issue: $ISSUE_TITLE"
          echo "Author: $ISSUE_AUTHOR"

      - name: Scan Codebase for Context
        id: scan-code
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          echo "ğŸ“‹ Scanning codebase for relevant context..."
          
          # Get recent commits for context with git as primary method
          echo "ğŸ“œ Collecting recent commits..." 
          if git log --oneline -5 > recent_commits.txt 2>git_error.log; then
            echo "âœ… Recent commits collected via git"
          else
            echo "âš ï¸ Failed to get recent commits via git:"
            cat git_error.log 2>/dev/null || echo "No git error details"
            echo "No recent commits available" > recent_commits.txt
          fi
          
          # Get main plugin files for context using reliable file system operations
          echo "ğŸ“ Collecting plugin file structure..."
          echo "ğŸ” Main plugin files:" > codebase_context.txt
          
          # Use git ls-files as primary method (more reliable than find)
          echo "ğŸ”§ Using git ls-files (primary method)..."
          if git ls-files "*.php" | head -10 > found_files.txt 2>git_error.log; then
            echo "âœ… Git ls-files successful"
            while read file; do
              if [ -f "$file" ] && [ -n "$file" ]; then
                echo "=== $file ===" >> codebase_context.txt
                echo "ğŸ” Processing: $file"
                if head -30 "$file" >> codebase_context.txt 2>/dev/null; then
                  echo "âœ… Added content from $file"
                else
                  echo "âš ï¸ Failed to read $file"
                fi
                echo "" >> codebase_context.txt
              fi
            done < found_files.txt
          else
            echo "âš ï¸ Git ls-files failed, using find as fallback..."
            cat git_error.log 2>/dev/null || echo "No git error details"
            
            # Find as fallback method
            if find . -name "*.php" -path "./.*" -prune -o -name "*.php" -print 2>/dev/null | head -10 > found_files.txt; then
              echo "âœ… Find fallback successful"
              while read file; do
                if [ -f "$file" ] && [ -n "$file" ]; then
                  echo "=== $file ===" >> codebase_context.txt
                  head -30 "$file" >> codebase_context.txt 2>/dev/null
                  echo "" >> codebase_context.txt
                fi
              done < found_files.txt
            else
              echo "âŒ Both git and find methods failed"
              echo "No PHP files found" >> codebase_context.txt
            fi
          fi
          
          # Add recent commits to context
          echo "" >> codebase_context.txt
          echo "ğŸ“œ Recent Git History:" >> codebase_context.txt
          cat recent_commits.txt >> codebase_context.txt
          
          # Check if we collected context with better validation
          if [ -s codebase_context.txt ] && [ $(wc -l < codebase_context.txt) -gt 5 ]; then
            echo "âœ… Codebase context collected: $(wc -l < codebase_context.txt) lines"
            echo "context-available=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Insufficient codebase context collected"
            echo "ğŸ” Context file size: $(wc -l < codebase_context.txt 2>/dev/null || echo '0') lines"
            echo "context-available=false" >> $GITHUB_OUTPUT
          fi

      - name: Create analysis prompt
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          CONTEXT_AVAILABLE: ${{ steps.scan-code.outputs.context-available }}
        run: |
          # Create issue-focused prompt - FOCUS ON USER'S PROBLEM FIRST
          echo "You are an expert Linux system administrator and LEMP stack automation specialist helping users solve server configuration problems." > analysis_prompt.txt
          echo "" >> analysis_prompt.txt
          echo "CRITICAL INSTRUCTION: FOCUS FIRST ON UNDERSTANDING THE USER'S ISSUE." >> analysis_prompt.txt
          echo "Then scan the codebase to find potential solutions or identify configuration-related causes." >> analysis_prompt.txt
          echo "" >> analysis_prompt.txt
          echo "ISSUE DETAILS:" >> analysis_prompt.txt
          echo "Title: $ISSUE_TITLE" >> analysis_prompt.txt
          echo "Author: @$ISSUE_AUTHOR" >> analysis_prompt.txt
          echo "Description:" >> analysis_prompt.txt
          echo "$ISSUE_BODY" >> analysis_prompt.txt
          echo "" >> analysis_prompt.txt
          echo "ANALYSIS APPROACH:" >> analysis_prompt.txt
          echo "1. Understand the server administration problem/request thoroughly" >> analysis_prompt.txt
          echo "2. Scan the bash scripts and configuration files for related functionality" >> analysis_prompt.txt
          echo "3. Identify potential configuration-based solutions or fixes" >> analysis_prompt.txt
          echo "4. Check for existing similar server automation functionality" >> analysis_prompt.txt
          echo "5. Provide actionable system administration recommendations" >> analysis_prompt.txt
          echo "" >> analysis_prompt.txt
          echo "REPOSITORY CONTEXT: EngineScript LEMP server automation (Ubuntu 24.04 LTS, Nginx, PHP 8.4+, MariaDB 11.8+, Redis, Cloudflare integration)" >> analysis_prompt.txt
          echo "" >> analysis_prompt.txt
          
          # Add codebase context if available
          if [ "$CONTEXT_AVAILABLE" = "true" ]; then
            echo "" >> analysis_prompt.txt
            echo "CODEBASE CONTEXT FOR REFERENCE:" >> analysis_prompt.txt
            cat codebase_context.txt >> analysis_prompt.txt
          fi
          
          # Add codebase context if available
          if [ "$CONTEXT_AVAILABLE" = "true" ]; then
            echo "" >> analysis_prompt.txt
            echo "CODEBASE CONTEXT FOR REFERENCE:" >> analysis_prompt.txt
            cat codebase_context.txt >> analysis_prompt.txt
          fi

      - name: Run AI Analysis
        id: ai-analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ¤– Starting AI issue analysis with official Google SDK..."
          echo "ğŸ“ Prompt file size: $(wc -c < analysis_prompt.txt) bytes"
          echo "ğŸ”‘ API key status: $([ -n "$GEMINI_API_KEY" ] && echo "âœ… Set" || echo "âŒ Missing")"
          
          if node gemini-analyze.js; then
            echo "analysis-success=true" >> $GITHUB_OUTPUT
            echo "âœ… AI analysis completed successfully"
          else
            echo "analysis-success=false" >> $GITHUB_OUTPUT
            echo "âŒ AI analysis failed - check logs for details"
          fi

          # Format the response with enhanced error handling
          echo "## ğŸ¤– Gemini Issue Analysis" > formatted_response.txt
          echo "" >> formatted_response.txt
          
          if [ -s gemini_response.txt ]; then
            echo "ğŸ“„ Adding analysis results ($(wc -c < gemini_response.txt) characters)"
            cat gemini_response.txt >> formatted_response.txt
          else
            echo "âš ï¸ No analysis results found - adding fallback message"
            echo "Analysis completed but encountered issues. Please review the issue manually and check the repository for related functionality." >> formatted_response.txt
          fi
          
          echo "" >> formatted_response.txt
          echo "---" >> formatted_response.txt
          echo "*Analysis performed by Gemini AI on $(date)*" >> formatted_response.txt
          
          # Debug: Show final response size
          echo "ğŸ“Š Final response size: $(wc -c < formatted_response.txt) characters"

      - name: Comment on Issue
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            
            let response = '';
            if (fs.existsSync('formatted_response.txt')) {
              response = fs.readFileSync('formatted_response.txt', 'utf8');
            } else {
              response = '## ğŸ¤– Gemini Issue Analysis\n\nAnalysis completed. Please review the codebase for potential solutions to this issue.';
            }

            // Get the issue number
            const issueNumber = context.issue.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: response
            });