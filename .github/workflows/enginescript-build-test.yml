name: EngineScript Nginx Build Test

on:
  pull_request:
    # Run on all pull requests for comprehensive testing
  push:
    # Run on all pushes to any branch for comprehensive testing
    paths:
      - 'scripts/**'
      - 'config/**'
      - 'enginescript-variables.txt'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  nginx-build-test:
    name: Nginx Build Test
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Maximize Disk Space
        run: |
          echo "ğŸ§¹ Freeing up disk space for full build..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /usr/local/.ghcup
          sudo docker system prune -af
          sudo apt-get autoremove -y
          sudo apt-get autoclean
          echo "ğŸ’¾ Available disk space:"
          df -h

      - name: Setup Nginx Build Environment
        run: |
          echo "ğŸ—ï¸ Setting up Nginx build environment..."
          sudo apt-get update -qq
          
          # Create required directories including log directories
          sudo mkdir -p /usr/local/bin/enginescript /home/EngineScript /var/log/EngineScript /tmp/ci-logs
          
          # Set proper permissions on log directory for file operations
          sudo chmod 755 /tmp/ci-logs
          sudo chown runner:runner /tmp/ci-logs
          
          # Copy entire project to build location
          sudo cp -r . /usr/local/bin/enginescript/
          
          # Copy CI configuration
          if [ -f .github/ci-config/enginescript-install-options-ci.txt ]; then
            sudo cp .github/ci-config/enginescript-install-options-ci.txt /home/EngineScript/enginescript-install-options.txt
            echo "âœ… CI configuration copied successfully"
          else
            echo "âš ï¸ CI configuration file not found, creating default"
            sudo touch /home/EngineScript/enginescript-install-options.txt
          fi
          
          # CRITICAL: Set executable permissions immediately after copying
          echo "ğŸ”§ Setting executable permissions on all scripts..."
          sudo find /usr/local/bin/enginescript -type f -name "*.sh" -exec chmod +x {} \;
          
          # Initialize main CI log with timestamp
          echo "EngineScript Nginx CI Build Started: $(date)" | sudo tee /tmp/ci-logs/ci-main.log
          echo "Build environment: Ubuntu $(lsb_release -rs)" | sudo tee -a /tmp/ci-logs/ci-main.log
          
          echo "âœ… Nginx build environment setup completed with proper permissions"

      - name: Run Base System Setup
        run: |
          echo "ğŸ”§ Running base system setup..."
          cd /usr/local/bin/enginescript
          
          # Set CI environment variable to bypass root checks in scripts
          export CI_ENVIRONMENT=true
          export DEBIAN_FRONTEND=noninteractive
          
          # Initialize setup log
          echo "EngineScript Base System Setup Started: $(date)" | sudo tee /tmp/ci-logs/setup.log
          
          # Check user privileges (CI runs as root via sudo)
          # In CI environment, force root context for script compatibility
          if ! sudo bash -c 'test "${EUID}" -eq 0'; then
            echo "ALERT: Unable to establish root context for EngineScript installation." | sudo tee -a /tmp/ci-logs/setup.log
            exit 1
          fi
          echo "âœ… Running with root privileges (CI environment)" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Check architecture
          BIT_TYPE=$(uname -m)
          if [ "${BIT_TYPE}" != 'x86_64' ]; then
            echo "EngineScript requires a 64-bit environment to run optimally." | sudo tee -a /tmp/ci-logs/setup.log
            exit 1
          fi
          echo "âœ… Detected 64-bit architecture: $BIT_TYPE" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Check Ubuntu version
          LINUX_TYPE=$(lsb_release -i | cut -d':' -f 2 | tr -d '[:space:]')
          UBUNTU_VERSION="$(lsb_release -sr)"
          
          if [ "$LINUX_TYPE" != "Ubuntu" ]; then
            echo "EngineScript does not support $LINUX_TYPE. Please use Ubuntu 22.04 or 24.04" | sudo tee -a /tmp/ci-logs/setup.log
            exit 1
          fi
          echo "âœ… Detected Linux Type: $LINUX_TYPE" | sudo tee -a /tmp/ci-logs/setup.log
          echo "âœ… Current Ubuntu Version: $UBUNTU_VERSION" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Install required packages for script (excluding problematic packages)
          echo "ğŸ“¦ Installing core packages..." | sudo tee -a /tmp/ci-logs/setup.log
          sudo apt update --allow-releaseinfo-change -y 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          
          # Core packages without dos2unix and tzdata (problematic in CI)
          core_packages="apt bash boxes cron coreutils curl git gzip nano openssl pwgen sed software-properties-common tar unattended-upgrades unzip zip"
          
          sudo apt install -qy $core_packages 2>&1 | sudo tee -a /tmp/ci-logs/setup.log || {
            echo "Error: Unable to install one or more packages. Exiting..." | sudo tee -a /tmp/ci-logs/setup.log
            exit 1
          }
          echo "âœ… Core packages installed successfully" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Check for required commands (excluding dos2unix)
          required_commands=("apt" "boxes" "git" "nano" "wget")
          for cmd in "${required_commands[@]}"; do
            if ! command -v $cmd &> /dev/null; then
              echo "Error: $cmd is not installed. Please install it and try again." | sudo tee -a /tmp/ci-logs/setup.log
              exit 1
            fi
          done
          echo "âœ… All required commands available" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Configure needrestart for automated restarts
          sudo sed -i "s/#\$nrconf{restart} = 'i';/\$nrconf{restart} = 'a';/" /etc/needrestart/needrestart.conf 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          echo "âœ… Configured needrestart for automated mode" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Upgrade software
          echo "ğŸ“ˆ Upgrading system packages..." | sudo tee -a /tmp/ci-logs/setup.log
          sudo apt upgrade -y 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          echo "âœ… System packages upgraded" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Create EngineScript directories (already done in earlier step, but ensure completeness)
          echo "ğŸ“ Creating EngineScript directories..." | sudo tee -a /tmp/ci-logs/setup.log
          sudo mkdir -p "/home/EngineScript/config-backups/nginx"
          sudo mkdir -p "/home/EngineScript/site-backups"
          sudo mkdir -p "/home/EngineScript/sites-list"
          sudo mkdir -p "/home/EngineScript/temp/site-export"
          sudo mkdir -p "/home/EngineScript/temp/site-import-completed-backups"
          sudo mkdir -p "/home/EngineScript/temp/site-import/root-directory"
          echo "âœ… EngineScript directories created" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Set directory and file permissions
          echo "ğŸ”§ Setting permissions..." | sudo tee -a /tmp/ci-logs/setup.log
          sudo find /usr/local/bin/enginescript -type d,f -exec chmod 755 {} \; 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          sudo chown -R root:root /usr/local/bin/enginescript 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          sudo find /usr/local/bin/enginescript -type f -iname "*.sh" -exec chmod +x {} \; 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          echo "âœ… Permissions set correctly" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Create EngineScript log files (already done in earlier step, but ensure completeness)
          echo "ğŸ“Š Creating log files..." | sudo tee -a /tmp/ci-logs/setup.log
          sudo touch "/var/log/EngineScript/install-error-log.txt"
          sudo touch "/var/log/EngineScript/install-log.txt"
          sudo touch "/var/log/EngineScript/vhost-export.log"
          sudo touch "/var/log/EngineScript/vhost-import.log"
          sudo touch "/var/log/EngineScript/vhost-install.log"
          sudo touch "/var/log/EngineScript/vhost-remove.log"
          echo "âœ… Log files created" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Skip logrotate setup (not needed for CI)
          echo "â­ï¸ Skipping logrotate setup (not needed for CI environment)" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Skip alias setup (not needed for CI) 
          echo "â­ï¸ Skipping alias setup (not needed for CI environment)" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Cleanup old packages
          echo "ğŸ§¹ Cleaning up old packages..." | sudo tee -a /tmp/ci-logs/setup.log
          sudo apt-get remove 'apache2.*' -y 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          echo "âœ… Old packages cleaned up" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Final update
          echo "ï¿½ Final system update..." | sudo tee -a /tmp/ci-logs/setup.log
          sudo apt update --allow-releaseinfo-change -y 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          sudo apt upgrade -y 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          
          # Skip timezone configuration (problematic in CI)
          echo "â­ï¸ Skipping timezone configuration (not suitable for CI environment)" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Skip unattended upgrades configuration (not needed for CI)
          echo "â­ï¸ Skipping unattended upgrades configuration (not needed for CI environment)" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Skip MOTD setup (not needed for CI)
          echo "â­ï¸ Skipping MOTD setup (not needed for CI environment)" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Skip HWE kernel installation (not suitable for CI)
          echo "â­ï¸ Skipping HWE kernel installation (not suitable for CI environment)" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Remove old downloads and clean up
          echo "ğŸ—‘ï¸ Final cleanup..." | sudo tee -a /tmp/ci-logs/setup.log
          sudo rm -rf /usr/src/*.tar.gz* 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          sudo apt clean -y 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          sudo apt autoremove --purge -y 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          sudo apt autoclean -y 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
          echo "âœ… Final cleanup completed" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Ensure options file exists (create if missing)
          if [ ! -f "/home/EngineScript/enginescript-install-options.txt" ]; then
            echo "ğŸ“ Creating default install options file..." | sudo tee -a /tmp/ci-logs/setup.log
            sudo cp -rf /usr/local/bin/enginescript/config/home/enginescript-install-options.txt /home/EngineScript/enginescript-install-options.txt 2>&1 | sudo tee -a /tmp/ci-logs/setup.log
            echo "âœ… Install options file created" | sudo tee -a /tmp/ci-logs/setup.log
          else
            echo "âœ… Install options file already exists" | sudo tee -a /tmp/ci-logs/setup.log
          fi
          
          echo "âœ… Base system setup completed successfully at $(date)" | sudo tee -a /tmp/ci-logs/setup.log
          
          # Ensure log is flushed and has content
          sudo sync
          if [ -s /tmp/ci-logs/setup.log ]; then
            echo "âœ… Setup log created successfully ($(wc -l < /tmp/ci-logs/setup.log) lines)"
          else
            echo "âš ï¸ Setup log is empty, creating summary"
            echo "Setup completed at $(date)" | sudo tee /tmp/ci-logs/setup.log
          fi

      - name: Remove Preinstalled Software
        run: |
          echo "ğŸ—‘ï¸ Removing preinstalled software..."
          cd /usr/local/bin/enginescript/scripts/install
          
          # Set CI environment variables
          export CI_ENVIRONMENT=true
          export DEBIAN_FRONTEND=noninteractive
          export NEEDRESTART_MODE=a
          export NEEDRESTART_SUSPEND=1
          
          # Debug: Check script exists and is executable
          echo "ğŸ” Checking remove-preinstalled.sh..."
          if [ -f "./removes/remove-preinstalled.sh" ]; then
            echo "âœ… remove-preinstalled.sh exists"
            ls -la ./removes/remove-preinstalled.sh
          else
            echo "âŒ remove-preinstalled.sh missing"
            ls -la ./removes/
            exit 1
          fi
          
          # Debug: Check environment and fix EUID issue
          echo "ğŸ” Environment check:"
          echo "Current user: $(whoami)"
          echo "EUID: $EUID"
          echo "PWD: $PWD"
          echo "CI_ENVIRONMENT: $CI_ENVIRONMENT"
          echo "DEBIAN_FRONTEND: $DEBIAN_FRONTEND"
          
          # Debug: Check required files exist
          echo "ğŸ” Checking required files..."
          if [ -f "/usr/local/bin/enginescript/enginescript-variables.txt" ]; then
            echo "âœ… enginescript-variables.txt exists"
          else
            echo "âŒ enginescript-variables.txt missing"
          fi
          
          if [ -f "/home/EngineScript/enginescript-install-options.txt" ]; then
            echo "âœ… enginescript-install-options.txt exists"
          else
            echo "âŒ enginescript-install-options.txt missing"
          fi
          
          # Run with enhanced debugging and CI-specific fixes
          echo "ğŸš€ Starting preinstalled software removal with debug output..."
          sudo bash -c "
            set -x
            cd /usr/local/bin/enginescript/scripts/install
            export CI_ENVIRONMENT=true
            export DEBIAN_FRONTEND=noninteractive
            export NEEDRESTART_MODE=a
            export NEEDRESTART_SUSPEND=1
            export APT_LISTCHANGES_FRONTEND=none
            
            # Force EUID to 0 for CI environment
            export EUID=0
            
            # Ensure package manager is ready
            echo 'Preparing package manager...'
            apt-get update -qq
            
            # Kill any hanging package managers
            killall -9 apt apt-get dpkg 2>/dev/null || true
            
            # Remove package manager locks
            rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock
            
            echo 'Starting remove-preinstalled.sh...'
            timeout 300 ./removes/remove-preinstalled.sh
          " 2>&1 | sudo tee /tmp/ci-logs/removes.log || {
            echo "âŒ Remove preinstalled software failed or timed out"
            echo "ğŸ“‹ Last 30 lines of output:"
            tail -30 /tmp/ci-logs/removes.log
            echo "ğŸ“‹ Full log file size: $(wc -l < /tmp/ci-logs/removes.log 2>/dev/null || echo 0) lines"
            exit 1
          }
          sudo sync
          echo "âœ… Preinstalled software removal completed"

      - name: Remove Default Nginx Installation
        run: |
          echo "ğŸ—‘ï¸ Removing default Nginx installation..."
          
          # Set CI environment variables
          export CI_ENVIRONMENT=true
          export DEBIAN_FRONTEND=noninteractive
          
          # Remove any existing Nginx installations
          echo "Stopping and removing existing Nginx services..." | sudo tee /tmp/ci-logs/nginx-removal.log
          sudo systemctl stop nginx 2>&1 | sudo tee -a /tmp/ci-logs/nginx-removal.log || echo "Nginx service not running"
          sudo systemctl disable nginx 2>&1 | sudo tee -a /tmp/ci-logs/nginx-removal.log || echo "Nginx service not enabled"
          
          # Remove Nginx packages completely
          sudo apt-get remove --purge nginx nginx-* -y 2>&1 | sudo tee -a /tmp/ci-logs/nginx-removal.log || echo "No nginx packages to remove"
          sudo apt-get autoremove -y 2>&1 | sudo tee -a /tmp/ci-logs/nginx-removal.log
          
          # Remove Nginx directories and files
          sudo rm -rf /etc/nginx/ 2>&1 | sudo tee -a /tmp/ci-logs/nginx-removal.log || echo "No /etc/nginx directory"
          sudo rm -rf /var/log/nginx/ 2>&1 | sudo tee -a /tmp/ci-logs/nginx-removal.log || echo "No /var/log/nginx directory"
          sudo rm -rf /var/www/html/ 2>&1 | sudo tee -a /tmp/ci-logs/nginx-removal.log || echo "No /var/www/html directory"
          sudo rm -f /usr/sbin/nginx 2>&1 | sudo tee -a /tmp/ci-logs/nginx-removal.log || echo "No nginx binary to remove"
          
          # Verify removal
          if command -v nginx >/dev/null 2>&1; then
            echo "âš ï¸ Nginx still present after removal attempt" | sudo tee -a /tmp/ci-logs/nginx-removal.log
          else
            echo "âœ… Nginx successfully removed" | sudo tee -a /tmp/ci-logs/nginx-removal.log
          fi
          
          sudo sync
          echo "âœ… Default Nginx removal completed"

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          cd /usr/local/bin/enginescript/scripts/install
          
          # Set CI environment variables with maximum verbosity
          export CI_ENVIRONMENT=true
          export DEBIAN_FRONTEND=noninteractive
          export NEEDRESTART_MODE=a
          export NEEDRESTART_SUSPEND=1
          
          # Debug: Check script exists and is executable
          echo "ğŸ” Checking depends-install.sh..."
          if [ -f "./depends/depends-install.sh" ]; then
            echo "âœ… depends-install.sh exists"
            ls -la ./depends/depends-install.sh
          else
            echo "âŒ depends-install.sh missing"
            ls -la ./depends/
            exit 1
          fi
          
          # Debug: Check environment and fix EUID issue
          echo "ğŸ” Environment check:"
          echo "Current user: $(whoami)"
          echo "EUID: $EUID"
          echo "PWD: $PWD"
          echo "CI_ENVIRONMENT: $CI_ENVIRONMENT"
          echo "DEBIAN_FRONTEND: $DEBIAN_FRONTEND"
          
          # Debug: Check required files exist
          echo "ğŸ” Checking required files..."
          if [ -f "/usr/local/bin/enginescript/enginescript-variables.txt" ]; then
            echo "âœ… enginescript-variables.txt exists"
          else
            echo "âŒ enginescript-variables.txt missing"
            ls -la /usr/local/bin/enginescript/ | head -10
          fi
          
          if [ -f "/home/EngineScript/enginescript-install-options.txt" ]; then
            echo "âœ… enginescript-install-options.txt exists"
          else
            echo "âŒ enginescript-install-options.txt missing"
            ls -la /home/EngineScript/
          fi
          
          # Run with enhanced debugging and CI-specific fixes
          echo "ğŸš€ Starting dependencies installation with debug output..."
          sudo bash -c "
            set -x
            cd /usr/local/bin/enginescript/scripts/install
            export CI_ENVIRONMENT=true
            export DEBIAN_FRONTEND=noninteractive
            export NEEDRESTART_MODE=a
            export NEEDRESTART_SUSPEND=1
            export APT_LISTCHANGES_FRONTEND=none
            
            # Force EUID to 0 for CI environment
            export EUID=0
            
            # Ensure package manager is ready
            apt-get update -qq
            
            # Kill any hanging package managers
            killall -9 apt apt-get dpkg 2>/dev/null || true
            
            # Remove package manager locks
            rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock
            
            timeout 300 ./depends/depends-install.sh
          " 2>&1 | sudo tee /tmp/ci-logs/depends.log || {
            echo "âŒ Dependencies installation failed or timed out"
            echo "ğŸ“‹ Last 50 lines of output:"
            tail -50 /tmp/ci-logs/depends.log
            echo "ğŸ“‹ Full log file size: $(wc -l < /tmp/ci-logs/depends.log 2>/dev/null || echo 0) lines"
            exit 1
          }
          sudo sync
          echo "âœ… Dependencies installation completed"

      - name: Install GCC
        run: |
          echo "ğŸ”¨ Installing GCC..."
          cd /usr/local/bin/enginescript/scripts/install
          
          # Set CI environment variables
          export CI_ENVIRONMENT=true
          export DEBIAN_FRONTEND=noninteractive
          
          sudo bash -c "cd /usr/local/bin/enginescript/scripts/install && timeout 600 ./gcc/gcc-install.sh" 2>&1 | sudo tee /tmp/ci-logs/gcc.log || {
            echo "âš ï¸ GCC installation had issues, continuing..."
            tail -30 /tmp/ci-logs/gcc.log
          }
          sudo sync
          echo "âœ… GCC installation completed"

      - name: Install OpenSSL
        run: |
          echo "ï¿½ Installing OpenSSL..."
          cd /usr/local/bin/enginescript/scripts/install
          
          # Set CI environment variables
          export CI_ENVIRONMENT=true
          export DEBIAN_FRONTEND=noninteractive
          
          sudo bash -c "cd /usr/local/bin/enginescript/scripts/install && timeout 900 ./openssl/openssl-install.sh" 2>&1 | sudo tee /tmp/ci-logs/openssl.log || {
            echo "âš ï¸ OpenSSL installation had issues, continuing..."
            tail -50 /tmp/ci-logs/openssl.log
          }
          sudo sync
          echo "âœ… OpenSSL installation completed"

      - name: Install PCRE
        run: |
          echo "ï¿½ Installing PCRE..."
          cd /usr/local/bin/enginescript/scripts/install
          
          # Set CI environment variables
          export CI_ENVIRONMENT=true
          export DEBIAN_FRONTEND=noninteractive
          
          sudo bash -c "cd /usr/local/bin/enginescript/scripts/install && timeout 600 ./pcre/pcre-install.sh" 2>&1 | sudo tee /tmp/ci-logs/pcre.log || {
            echo "âš ï¸ PCRE installation had issues, continuing..."
            tail -30 /tmp/ci-logs/pcre.log
          }
          sudo sync
          echo "âœ… PCRE installation completed"

      - name: Install Zlib
        run: |
          echo "ğŸ“¦ Installing Zlib..."
          cd /usr/local/bin/enginescript/scripts/install
          
          # Set CI environment variables
          export CI_ENVIRONMENT=true
          export DEBIAN_FRONTEND=noninteractive
          
          sudo bash -c "cd /usr/local/bin/enginescript/scripts/install && timeout 600 ./zlib/zlib-install.sh" 2>&1 | sudo tee /tmp/ci-logs/zlib.log || {
            echo "âš ï¸ Zlib installation had issues, continuing..."
            tail -30 /tmp/ci-logs/zlib.log
          }
          sudo sync
          echo "âœ… Zlib installation completed"

      - name: Build Nginx Component
        run: |
          echo "ğŸ”¨ Building Nginx component..."
          cd /usr/local/bin/enginescript/scripts/install
          
          # Set CI environment variables to bypass root checks
          export CI_ENVIRONMENT=true
          export DEBIAN_FRONTEND=noninteractive
          
          # Build Nginx with custom optimizations
          echo "ğŸŒ Building Nginx..."
          sudo bash -c "cd /usr/local/bin/enginescript/scripts/install && timeout 1200 ./nginx/nginx-install.sh" 2>&1 | sudo tee /tmp/ci-logs/nginx.log || {
            echo "âŒ Nginx build failed"
            tail -50 /tmp/ci-logs/nginx.log
            exit 1
          }
          
          # Ensure log is flushed and has content
          sudo sync
          if [ -s /tmp/ci-logs/nginx.log ]; then
            echo "âœ… Nginx build log created successfully ($(wc -l < /tmp/ci-logs/nginx.log) lines)"
          else
            echo "âš ï¸ Nginx build log is empty, creating summary"
            echo "Nginx build completed at $(date)" | sudo tee /tmp/ci-logs/nginx.log
          fi
          
          echo "âœ… Nginx build completed"

      - name: Verify Nginx Build Results
        if: always()
        run: |
          echo "ğŸ” Verifying Nginx build results..."
          
          # Check if Nginx binary exists and works
          if [ -f /usr/sbin/nginx ]; then
            echo "âœ… Nginx binary installed at /usr/sbin/nginx"
            /usr/sbin/nginx -v 2>&1 || echo "âš ï¸ Nginx version check failed"
          else
            echo "âŒ Nginx binary missing"
          fi
          
          # Check Nginx configuration
          echo "ğŸ“ Nginx configuration:"
          [ -f /etc/nginx/nginx.conf ] && echo "âœ… Nginx config exists" || echo "âŒ Nginx config missing"
          
          # Test Nginx configuration syntax
          if [ -f /usr/sbin/nginx ]; then
            /usr/sbin/nginx -t 2>&1 && echo "âœ… Nginx configuration syntax valid" || echo "âŒ Nginx configuration syntax invalid"
          fi
          
          # Show disk usage
          echo "ğŸ’¾ Final disk usage:"
          df -h
          
          echo "ğŸ“Š Build artifacts summary:"
          du -sh /usr/local/bin/enginescript/ 2>/dev/null || echo "Build directory size unknown"
          du -sh /var/log/EngineScript/ 2>/dev/null || echo "Log directory size unknown"

      - name: Report Test Results
        if: always()
        run: |
          echo "ğŸ“‹ Generating comprehensive test results..."
          
          # Initialize result variables
          NGINX_STATUS="âŒ Failed"
          OVERALL_STATUS="âŒ FAILED"
          
          # Check Nginx status based on binary and logs
          if [ -f /usr/sbin/nginx ] && /usr/sbin/nginx -v >/dev/null 2>&1; then
            NGINX_STATUS="âœ… Success"
          fi
          
          # Determine overall status based on Nginx only
          if [[ "$NGINX_STATUS" == "âœ… Success" ]]; then
            OVERALL_STATUS="âœ… SUCCESS"
          fi
          
          # Create comprehensive test summary
          cat > /tmp/ci-logs/test-summary.md << EOF
          # EngineScript Nginx Build Test Results
          
          ## ğŸ¯ Overall Status
          **$OVERALL_STATUS**
          
          ## ğŸ“¦ Component Results
          
          | Component | Status | Version | Config |
          |-----------|--------|---------|--------|
          | **Nginx** | $NGINX_STATUS | $([ -f /usr/sbin/nginx ] && /usr/sbin/nginx -v 2>&1 | head -1 | cut -d' ' -f3 | cut -d'/' -f2 || echo "Not installed") | $([ -f /etc/nginx/nginx.conf ] && echo "âœ… Present" || echo "âŒ Missing") |
          
          ## ğŸ“Š Build Environment
          - **OS**: Ubuntu $(lsb_release -rs)
          - **Architecture**: $(uname -m)
          - **Build Time**: $(date)
          - **Workflow**: ${{ github.workflow }}
          - **Run ID**: ${{ github.run_id }}
          
          ## ğŸ“ Log Files Generated
          $(ls -la /tmp/ci-logs/ 2>/dev/null | grep -E '\.log$' | wc -l) log files created:
          $(ls -1 /tmp/ci-logs/*.log 2>/dev/null | sed 's/.*\//- /' || echo "- No log files found")
          
          ## ğŸ’¾ Disk Usage
          **Build Directory**: $(du -sh /usr/local/bin/enginescript/ 2>/dev/null | cut -f1 || echo "Unknown")
          **Logs Directory**: $(du -sh /tmp/ci-logs/ 2>/dev/null | cut -f1 || echo "Unknown")
          **Available Space**: $(df -h / | tail -1 | awk '{print $4}')
          
          EOF
          
          echo "ğŸ“‹ Test Summary Generated:"
          cat /tmp/ci-logs/test-summary.md
          
          # Set output for potential PR commenting
          echo "OVERALL_STATUS=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "NGINX_STATUS=$NGINX_STATUS" >> $GITHUB_OUTPUT
          
          # Create simple status for PR comment
          if [ "$OVERALL_STATUS" = "âœ… SUCCESS" ]; then
            cat > /tmp/ci-logs/pr-comment.md << EOF
          ğŸ‰ **EngineScript Nginx Build Test PASSED** ğŸ‰
          
          Nginx core component built successfully:
          - Nginx: $NGINX_STATUS
          
          âœ… Ready for deployment testing!
          EOF
          else
            cat > /tmp/ci-logs/pr-comment.md << EOF
          âš ï¸ **EngineScript Nginx Build Test FAILED** âš ï¸
          
          Component status:
          - Nginx: $NGINX_STATUS
          
          ğŸ“‹ Please review the build logs for detailed error information.
          EOF
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const comment = fs.readFileSync('/tmp/ci-logs/pr-comment.md', 'utf8');
              
              // Find existing comment to update
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('EngineScript') && comment.body.includes('Build Test')
              );
              
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Could not read PR comment file or post comment:', error);
              console.log('PR commenting failed, but this is not critical for the build');
            }

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nginx-build-logs-ubuntu-24.04
          path: |
            /tmp/ci-logs/*
            /var/log/EngineScript/
          retention-days: 7
          
      - name: Final Status Check
        if: always()
        run: |
          echo "ğŸ Final workflow status check..."
          
          # Check if Nginx is working
          FAILED_COMPONENTS=0
          
          if ! [ -f /usr/sbin/nginx ] || ! /usr/sbin/nginx -v >/dev/null 2>&1; then
            echo "âŒ Nginx build/installation failed"
            FAILED_COMPONENTS=$((FAILED_COMPONENTS + 1))
          fi
          
          if [ $FAILED_COMPONENTS -eq 0 ]; then
            echo "ğŸ‰ Nginx successfully built and installed!"
            echo "âœ… EngineScript Nginx build test PASSED"
            exit 0
          else
            echo "ğŸ’¥ Nginx failed to build/install"
            echo "âŒ EngineScript Nginx build test FAILED"
            exit 1
          fi