# 0 = default. Depending on the maps below, this either means that the request will not be blocked or that it can be cached.
# 1 = blocked, return 403 response.
# 2 = no cache.

# Sessions that should skip FastCGI cache
map $http_cookie $es_http_cookie {
  default                                                       0;
  "~*comment_author(_email_)?"                                  2;
  "~*edd(_items_in_cart)?"                                      2;
  "~*no_?cache"                                                 2;
  "~*woocommerce_(cart_hash|items_in_cart|recently_viewed)"     2;
  "~*wordpress_[a-f0-9]+"                                       2;
  "~*wordpress_(logged_in|no_cache)"                            2;
  "~*wp(-postpass|touch_switch_toggle)"                         2;
}

# Untrustworthy sites
map $http_referer $es_http_referer {
  default                                                       0;
  "~*domaincrawler\.com"                                        1;
  "~*maywevisit\.com"                                           1;
  "~*pipdigz\.co\.uk"                                           1;
  "~*semalt\.com"                                               1;
  "~*semrush\.com"                                              1;
  "~*virtubox\.net"                                             1;
  "~*vtb\.cx"                                                   1;
  "~*wordpresstesting\.com"                                     1;
}

# Untrustworthy user agents and mobile device cache skip
map $http_user_agent $es_http_user_agent {
  default                                                       0;
  "~*(AhrefsBot|B(LEXBot|aiduspider)|LinkpadBot|SemrushBot|TwengaBot|acunetix|binlar|c(asper|h(eckpriv|oppy)|lshttp|msworld)|d(iavol|omaincrawler\.com|otbot)|extract|f(eedfinder|licky)|g(00g1e|rab)|h(arvest|eritrix|ttrack)|kmccrew|loader|miner|n(ikto|utch)|p(lanetwork|ostrank|urebot|y(curl|thon(-requests)?))|s(eekerspider|iclab|kygrid|qlmap|ucker)|turnit|vikspider|winhttp|xxxyy|youda|z(meu|une))" 1;
  "~*(Android|Blackberry|IEMobile|iP(ad|hone))"                 2;
  "~*Chrome/[.0-9]* (Mobile)"                                   2;
  "~*Firefox.*Mobile"                                           2;
  "~*ipod.*mobile"                                              2;
  "~*Kindle"                                                    2;
  "~*Mobile"                                                    2;
  "~*Opera\ M(ini|obile)"                                       2;
  "~*Tablet"                                                    2;
  "~*Windows\ Phone"                                            2;
}

map $http_x_requested_with $es_http_x_request_with {
  default                                                       0;
  "XMLHttpRequest"                                              2;
}

# Bad query strings
#map $query_string $es_query_string {
  #default                                                      0;
  #"~*(eval\()"                                                 1;
  #"~*(127\.0\.0\.1)"                                           1;
  #"~*(javascript:)(.*)(;)"                                     1;
  #"~*(base64_encode)(.*)(\()"                                  1;
  #"~*(GLOBALS|REQUEST)(=|\[|%)"                                1;
  #"~*(<|%3C)(.*)script(.*)(>|%3)"                              1;
  #"~*(\\|\.\.\.|\.\./|~|`|<|>|\|)"                             1;
  #"~*(boot\.ini|etc/passwd|self/environ)"                      1;
  #"~*(thumbs?(_editor|open)?|tim(thumb)?)\.php"                1;
  #"~*(\'|\")(.*)(drop|insert|md5|select|union)"                1;
#}

# HTTP Methods
# Cache GET & HEAD methods
# Don't cache remaining methods used by REST API (DELETE, PATCH, POST, PUT)
# Block all other HTTP methods
map $request_method $es_request_method {
  default                                                       0;  # GET & HEAD
  "~*^(CONNECT|DEBUG|MOVE|TRACE|TRACK)$"                        1;
  "~*^(DELETE|PATCH|POST|PUT)$"                                 2;
}

map $request_uri $es_request_uri {
  default                                                       0;
  "~*\.(as(c|px?)|b(a(k|sh|t)|lade\.php)?|c(fg|gi|md|onf|sh)|d(ll|ump)|e(ngine|xe)|git(ignore)?|hg|in(c|fo|i|stall)|jsp|l(og|ua)|m(ake|db|o(dule|v))|o(ld|rig(inal)?|ut)|p(em|l|o|rofile|y)|rdf|s(ave|h|ql|vn|w(o|p))|t(est|heme|pl|wig)|xtmpl)$" 1;
  "~*(changelog|example|install(ation?)|l(egalnotice|icense)|readme|wp-config)\.(html?|md|php|rst|txt)$" 1;
  "~*(G(em|runt)file|auth|composer(\/installed)?|package(-lock)?|yarn)\.(json|lock)$" 1;
  "~*gems\.(rb|locked)?$"                                       1;
  "~*/wp-content/uploads/.*\.(js|php|(p|s)?html?|swf|tpl)$"     1;
  "~*/wp-content/uploads/woe/.*\.(csv|xls)$"                    2;
  #"~*/(wp-content)/(.*?)\.(7z|bz2|rar|tar|zip)$"               1;
  "~*/[a-z0-9_-]+-sitemap([0-9]+)?.xml"                         2;
  "~*/account.*"                                                2;
  "~*/add_to_cart.*"                                            2;
  "~*/addons.*"                                                 2;
  "~*/cart.*"                                                   2;
  "~*/chat.*"                                                   2;
  "~*/checkout.*"                                               2;
  "~*/contact.*"                                                2;
  "~*/(customer-)?dashboard.*"                                  2;
  "~*/edd-sl.*"                                                 2;
  "~*/feed.*"                                                   2;
  "~*/index\.php"                                               2;
  "~*/log(in|out)."                                             2;
  "~*/lost-?password.*"                                         2;
  "~*/my-(account|courses).*"                                   2;
  "~*/order.*"                                                  2;
  "~*/pro(file|duct-category).*"                                2;
  "~*/register.*"                                               2;
  "~*/resetpass.*"                                              2;
  "~*/settings.*"                                               2;
  #"~*/shop.*"                                                  2;
  "~*/sitemap(_index)?\.xml"                                    2;
  #"~*/store.*"                                                 2;
  "~*/support.*"                                                2;
  "~*/view.*"                                                   2;
  "~*/wc-api.*"                                                 2;
  "~*/wp-.*\.php"                                               2;
  "~*/wp-admin.*"                                               2;
  "~*/wp-content/updraft.*"                                     1;
  "~*/wp-json.*"                                                2;
  "~*/xmlrpc\.php"                                              2;
}
