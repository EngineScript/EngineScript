# 0 = default. Depending on the maps below, this either means that the request will not be blocked or that it can be cached.
# 1 = blocked, return 403 response.
# 2 = no cache.

# Sessions that should skip FastCGI cache
map $http_cookie $es_http_cookie {
  default                                 0;
  "~*bookly_?"                            2;
  "~*comment_"                            2;
  "~*e(c(_|wid)|dd_)"                     2;
  "~*jetpack"                             2;
  "~*no_?cache"                           2;
  "~*woocommerce_(cart_hash|items_in_cart|recently_viewed)" 2;
  "~*wordpress_"                          2;
  #"~*wp_woocommerce_session_"            2;
  "~*wp(-|sc_)"                           2;
  "~*xf_"                                 2;
  "~*yith_w(cwl_session|rvp)"             2;
}

# Untrustworthy sites
#map $http_referer $es_http_referer {
#  default                                0;
#  "~*domaincrawler\.com"                 1;
#  "~*pipdigz\.co\.uk"                    1;
#  "~*semalt\.com"                        1;
#  "~*semrush\.com"                       1;
#  "~*virtubox\.net"                      1;
#  "~*vtb\.cx"                            1;
#  "~*wordpresstesting\.com"              1;
#}

# Untrustworthy user agents and mobile device cache skip
# You'll want to enable this if you have a non-responsive theme that shouldn't cache mobile users
#map $http_user_agent $es_http_user_agent {
#  default                                0;
#  #"~*(AhrefsBot|B(LEXBot|aiduspider)|LinkpadBot|SemrushBot|TwengaBot|acunetix|binlar|c(asper|h(eckpriv|oppy)|lshttp|msworld)|d(iavol|omaincrawler\.com|otbot)|extract|f(eedfinder|licky)|g(00g1e|rab)|h(arvest|eritrix|ttrack)|kmccrew|loader|miner|n(ikto|utch)|p(lanetwork|ostrank|urebot|y(curl|thon(-requests)?))|s(eekerspider|iclab|kygrid|qlmap|ucker)|turnit|vikspider|winhttp|xxxyy|youda|z(meu|une))" 1;
#  "~*(Android|Blackberry|IEMobile|iP((a|o)d|hone))"  2;
#  "~*Chrome/[.0-9]*\ (Mobile)"           2;
#  "~*Firefox.*Mobile"                    2;
#  "~*ipod.*mobile"                       2;
#  "~*Kindle"                             2;
#  "~*Mobile"                             2;
#  "~*Opera\ M(ini|obile)"                2;
#  "~*Tablet"                             2;
#  "~*Windows\ Phone"                     2;
#}

map $http_x_requested_with $es_http_x_request_with {
  default                                 0;
  "XMLHttpRequest"                        2;
}

# Bad query strings
#map $query_string $es_query_string {
  #default                                0;
#}

# HTTP Methods
# Cache GET & HEAD methods
# Don't cache remaining methods used by REST API (DELETE, PATCH, POST, PUT)
# Block all other HTTP methods
map $request_method $es_request_method {
  default                                 0;  # GET & HEAD
  "~*^(CONNECT|DEBUG|MOVE|TRACE|TRACK)$"  1;
  "~*^(DELETE|OPTIONS|PATCH|POST|PUT)$"   2;
}

map $request_uri $es_request_uri {
  default                                 0;
  "~*\.(?:as(c|px?)|b(a(k|sh|t)|lade(\.php)?)|c(fg|gi|md|onf|sh)|d(ll|ump)|e(ngine|xe)|git(ignore)?|hg|in(c|fo|i|stall)|jsp|l(og|ua)|m(ake|db|o(dule|v))|o(ld|rig(inal)?|ut)|p(em|l|o|rofile|y)|rdf|s(ave|h|ql|vn|w[op])|t(est|heme|pl|wig)|xtmpl)$" 1;
  "~*(.*)?sitemap(.*)?\.(?:html|x[ms]l)$" 2;
  "~*(changelog|example|install(ation?)|l(egalnotice|icense)|readme|wp-config)\.(?:html?|md|php|rst|txt)$" 1;
  "~*(G(em|runt)file|auth|composer(/installed)?|package(-lock)?|yarn)\.(?:json|lock)$" 1;
  #"~*/(wp-content)\/.*\.(?:7z|bz2|[rt]ar|zip)$"  1; # Disables compressed files from being accessed from the wp-content directory. Be careful with this as it will stop you from being able to manually upload plugins/themes or access backups
  "~*\?add-to-cart="                      2;  # WooCommerce
  "~*\?wc-ajax="                          2;  # WooCommerce
  "~*\?wc-api="                           2;  # WooCommerce
  "~*add_to_cart.*"                       2;
  "~*gems\.(?:rb|locked)?$"               1;
  "~*/addons.*"                           2;
  "~*/cart.*"                             2;  # WooCommerce
  "~*/certificate.*"                      2;  # Sensei
  "~*/chat.*"                             2;
  "~*/checkout.*"                         2;  # WooCommerce
  "~*/contact.*"                          2;
  #"~*/course.*"                          2;  # Sensei
  "~*/(customer-)?dashboard.*"            2;
  "~*/edd-sl.*"                           2;  # Easy Digital Downloads
  "~*/feed.*"                             2;
  "~*/index\.php"                         2;
  #"~*/lesson.*"                          2;  # Sensei
  "~*/log(in|out).*"                      2;
  "~*/lost-?password.*"                   2;
  "~*/my-(account|courses).*"             2;  # WooCommerce & Sensei
  "~*/order.*"                            2;  # WooCommerce
  #"~*/product-category.*"                2;  # WooCommerce
  "~*/profile.*"                          2;
  "~*/register.*"                         2;
  "~*/resetpass.*"                        2;
  "~*/settings.*"                         2;
  #"~*/shop.*"                            2;
  #"~*/store.*"                           2;
  "~*/support.*"                          2;
  "~*/view.*"                             2;
  "~*/wc-api.*"                           2;
  "~*/wp-(.*\.php|admin.*|json.*)"        2;
  "~*/wp-content/updraft.*"               1;  # Updraft
  "~*/wp-content/uploads/.*\.(?:js|php|[ps]?html?|swf|tpl)$"  1;
  "~*/wp-content/uploads/woe/.*\.(?:csv|xls)$"  2;
  "~*/xmlrpc\.php"                        2;
}

# Expires
# Credit: https://github.com/h5bp/server-configs-nginx/blob/main/h5bp/web_performance/cache_expiration.conf
map $sent_http_content_type $expires {
  default                                 1y;

  # No content
  ""                                      off;

  # CSS
  ~*text/css                              1y;

  # Data interchange
  ~*application/atom\+xml                 1h;
  ~*application/rdf\+xml                  1h;
  ~*application/rss\+xml                  1h;
  ~*application/json                      epoch;
  ~*application/ld\+json                  epoch;
  ~*application/schema\+json              epoch;
  ~*application/geo\+json                 epoch;
  ~*application/xml                       epoch;
  ~*text/calendar                         epoch;
  ~*text/xml                              epoch;

  # Favicon (cannot be renamed!) and cursor images
  ~*image/vnd.microsoft.icon              1w;
  ~*image/x-icon                          1w;

  # HTML
  ~*text/html                             epoch;

  # JavaScript
  ~*application/javascript                1y;
  ~*application/x-javascript              1y;
  ~*text/javascript                       1y;

  # Manifest files
  ~*application/manifest\+json            1w;
  ~*application/x-web-app-manifest\+json  epoch;
  ~*text/cache-manifest                   epoch;

  # Markdown
  ~*text/markdown                         epoch;

  # Media files
  ~*audio/                                1y;
  ~*image/                                1y;
  ~*video/                                1y;

  # WebAssembly
  ~*application/wasm                      1y;

  # Web fonts
  ~*font/                                 1y;
  ~*application/vnd.ms-fontobject         1y;
  ~*application/x-font-ttf                1y;
  ~*application/x-font-woff               1y;
  ~*application/font-woff                 1y;
  ~*application/font-woff2                1y;

  # Other
  ~*text/x-cross-domain-policy            1w;
}

expires $expires;

map $upstream_http_x_wp_cf_super_cache_active $wp_cf_super_cache_active {
  default  'no-cache, no-store, must-revalidate, max-age=0';
  '1' 's-maxage=31536000, max-age=60';
}
