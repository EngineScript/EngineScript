# YOURDOMAIN Admin Subdomain
#
# To connect to the admin control panel, you must have a domain installed on the
# EngineScript server. Once you have a domain, you can connect to the admin panel
# by going to https://admin.yourdomain.com and using the credentials you set
# during installation under the Admin Control Panel Login section.
# You can review the options you set with the console command: es.config

server {
  listen 443 ssl;
  listen [::]:443 ssl;
  #listen 443 quic reuseport; # HTTP3
  #listen [::]:443 quic reuseport; # HTTP3
  server_name admin.YOURDOMAIN;

  # SSL Certificates
  ssl_certificate /etc/nginx/ssl/YOURDOMAIN/fullchain.pem;
  ssl_certificate_key /etc/nginx/ssl/YOURDOMAIN/key.pem;
  ssl_client_certificate /etc/nginx/ssl/cloudflare/origin-pull-ca.pem;
  ssl_trusted_certificate /etc/nginx/ssl/YOURDOMAIN/ca.pem;

  # SSL Settings
  include /etc/nginx/ssl/sslshared.conf;

  # Root directory for EngineScript Control Panel
  # Tools (phpMyAdmin, TinyFileManager, etc.) are in /var/www/admin/tools/
  # and accessed via location blocks below
  root /var/www/admin/control-panel;

  # Admin Control Panel Protection
  # Adds a basic authentication prompt to the admin control panel.
  # You can review the options you set with the console command: es.config
  satisfy any;
  auth_basic "Restricted Access: Admin Control Panel";
  auth_basic_user_file /etc/nginx/restricted-access/.htpasswd;
  allow 127.0.0.1;
  allow ::1;
  #deny all;

  # FastCGI_Cache Disable
  fastcgi_cache off;
  set $skip_cache 1;

  # EngineScript Control Panel - Default Location (Landing Page)
  location / {
    try_files $uri $uri/ /index.html =404;
  }

  # API Endpoints for EngineScript Control Panel
  location /api {
    rewrite ^/api/(.*)$ /api.php?endpoint=$1 last;
  }

  # Direct service endpoints (legacy support)
  location /services {
    rewrite ^/services/(.*)$ /api.php?endpoint=services/$1 last;
  }

  # ============================================================
  # Admin Tools - Separate directory from control panel
  # Tools are stored in /var/www/admin/tools/ to prevent
  # EngineScript updates from overwriting tool configurations
  # ============================================================

  # phpMyAdmin - Database management tool
  location /phpmyadmin {
    alias /var/www/admin/tools/phpmyadmin;
    index index.php;

    location ~ \.php$ {
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_param SCRIPT_FILENAME $request_filename;
      include /etc/nginx/globals/php-fpm.conf;
    }
  }

  # TinyFileManager - File management tool
  location /tinyfilemanager {
    alias /var/www/admin/tools/tinyfilemanager;
    index tinyfilemanager.php;

    location ~ \.php$ {
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_param SCRIPT_FILENAME $request_filename;
      include /etc/nginx/globals/php-fpm.conf;
    }
  }

  # phpSysInfo - System information tool
  location /phpsysinfo {
    alias /var/www/admin/tools/phpsysinfo;
    index index.php;

    location ~ \.php$ {
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_param SCRIPT_FILENAME $request_filename;
      include /etc/nginx/globals/php-fpm.conf;
    }
  }

  # phpinfo - PHP information page
  location /phpinfo {
    alias /var/www/admin/tools/phpinfo;
    index index.php;

    location ~ \.php$ {
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_param SCRIPT_FILENAME $request_filename;
      include /etc/nginx/globals/php-fpm.conf;
    }
  }

  # Adminer - Lightweight database management tool
  location /adminer {
    alias /var/www/admin/tools/adminer;
    index index.php;

    location ~ \.php$ {
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_param SCRIPT_FILENAME $request_filename;
      include /etc/nginx/globals/php-fpm.conf;
    }
  }

  # OpCache GUI - PHP OpCache status and management
  location /opcache-gui {
    alias /var/www/admin/tools/opcache-gui;
    index index.php;

    location ~ \.php$ {
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_param SCRIPT_FILENAME $request_filename;
      include /etc/nginx/globals/php-fpm.conf;
    }
  }

  # PHP processing for control panel root
  location ~ \.php$ {
    # Regex to split $uri to $fastcgi_script_name and $fastcgi_path
    fastcgi_split_path_info ^(.+\.php)(/.+)$;

    include /etc/nginx/globals/php-fpm.conf;
  }

  # Logs
  # Access log is enabled just for the admin subdomain for security auditing purposes.
  access_log /var/log/domains/admin.YOURDOMAIN-nginx-access.log main buffer=128k flush=5m;
  error_log /var/log/domains/admin.YOURDOMAIN-nginx-error.log error;
}
