# YOURDOMAIN Admin Subdomain
#
# To connect to the admin control panel, you must have a domain installed on the
# EngineScript server. Once you have a domain, you can connect to the admin panel
# by going to https://admin.yourdomain.com and using the credentials you set
# during installation under the Admin Control Panel Login section.
# You can review the options you set with the console command: es.config

server {
  listen 443 ssl;
  listen [::]:443 ssl;
  #listen 443 quic reuseport; # HTTP3
  #listen [::]:443 quic reuseport; # HTTP3
  server_name admin.YOURDOMAIN;

  # SSL Certificates
  ssl_certificate /etc/nginx/ssl/YOURDOMAIN/fullchain.pem;
  ssl_certificate_key /etc/nginx/ssl/YOURDOMAIN/key.pem;
  ssl_client_certificate /etc/nginx/ssl/cloudflare/origin-pull-ca.pem;
  ssl_trusted_certificate /etc/nginx/ssl/YOURDOMAIN/ca.pem;

  # SSL Settings
  include /etc/nginx/ssl/sslshared.conf;

  root /var/www/admin/enginescript;

  # Admin Control Panel Protection
  # Adds a basic authentication prompt to the admin control panel.
  # You can review the options you set with the console command: es.config
  satisfy any;
  auth_basic "Restricted Access: Admin Control Panel";
  auth_basic_user_file /etc/nginx/restricted-access/.htpasswd;
  allow 127.0.0.1;
  allow ::1;
  #deny all;

  # FastCGI_Cache Disable
  fastcgi_cache off;
  set $skip_cache 1;

  # EngineScript Control Panel - Default Location
  location / {
    try_files $uri $uri/ /index.html =404;
  }

  # API Endpoints for EngineScript Control Panel
  location /api {
    rewrite ^/api/(.*)$ /api.php?endpoint=$1 last;
  }

  location ~ \.php$ {
    # Regex to split $uri to $fastcgi_script_name and $fastcgi_path
    fastcgi_split_path_info ^(.+\.php)(/.+)$;

    include /etc/nginx/globals/php-fpm.conf;
  }

  # Logs
  # Access log is enabled just for the admin subdomain for security auditing purposes.
  access_log /var/log/domains/admin.YOURDOMAIN-nginx-access.log main buffer=128k flush=5m;
  error_log /var/log/domains/admin.YOURDOMAIN-nginx-error.log error;
  }
